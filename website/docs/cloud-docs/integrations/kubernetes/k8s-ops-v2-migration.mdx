---
page_title: Terraform Cloud Kubernetes Operator v2 Migration Guide
description: >-
  Upgrade the Terraform Cloud Kubernetes Operator from version 1 to version 2.
tfc_only: false
---

# Terraform Cloud Kubernetes Operator v2 Migration Guide

To upgrade the Terraform Cloud Kubernetes Operator from version 1 to version 2, there is a one-time process that you need to complete. This process will upgrade the operator to the newest version and migrate your custom resources. 

## Prepare for the upgrade

Before you migrate to `v2` of the operator, you must first [update `v1` of the operator to the latest version](/terraform/cloud-docs/integrations/kubernetes#upgrading), including the custom resource definitions.

Next, backup the workspace resources.

```shell-session
$ kubectl get workspace --all-namespaces -o yaml > backup_tfc_operator_v1.yaml
```

Finally, we suggest that you set the `applyMethod` of each workspace to `manual`. In version 2 of the Terraform Cloud Kubernetes Operator this is the default value, however explicitly configuring it with the value provides extra protection from unintended automatic applies running during the upgrade process.

```shell-session
kubectl patch workspace <WORKSPACE_NAME> --type=merge --patch '{"spec": {"applyMethod": "manual"}}'
```
## Upgrade the operator

Validate the changes that **patch A** will apply to the workspace CRD.

```shell-session
$ kubectl diff -f https://raw.githubusercontent.com/hashicorp/terraform-cloud-operator/main/docs/migration/crds/workspaces_patch_a.yaml
```

Patch the workspace CRD with **patch A**. This patch adds `app.terraform.io/v1alpha2` support, but excludes `.status.runStatus` because it has a different format in `app.terraform.io/v1alpha1` and causes JSON unmarshalling issues.

```shell-session
$ kubectl patch crd workspaces.app.terraform.io --patch-file https://raw.githubusercontent.com/hashicorp/terraform-cloud-operator/main/docs/migration/crds/workspaces_patch_a.yaml
```

Install `v2` following [Installation Guide](https://github.com/hashicorp/terraform-cloud-operator/blob/main/docs/installation.md) or the [Installation Guide for Beta](https://github.com/hashicorp/terraform-cloud-operator/tree/main#install-beta-version).

Next, create a Kubernetes secret to store the TFC API token following the [Usage Guide](https://github.com/hashicorp/terraform-cloud-operator/blob/main/docs/usage.md#prerequisites). The API token can be copied from the Kubernetes secret that you created for `v1` of the operator. By default, this is named `terraformrc`. Use the `kubectl get secret` command to get the API token.

```shell-session
$ kubectl get secret terraformrc -o json | jq '.data.credentials' | tr -d '"' | base64 -d
```
If `v2` of the operator pod fails to start, ensure that each `workspace` object has the `spec.token` value set. To do this, patch each `workspace` object using the `kubectl patch` command.

```shell-session
$ kubectl patch workspace <WORKSPACE_NAME> --type=merge --patch '{"spec": {"terraformVersion": "1.4.6", "token": {"secretKeyRef": {"key": "token", "name": "tfc-operator"}}}}'
```

Validate

```shell-session
$ kubectl logs -f <POD_NAME>
```

Validate the changes that **patch B** will apply to the workspace CRD:

```shell-session
$ kubectl diff -f https://raw.githubusercontent.com/hashicorp/terraform-cloud-operator/main/docs/migration/crds/workspaces_patch_b.yaml
```

Patch workspace CRD with **patch B**. This patch adds `.status.runStatus` support that was excluded in Patch A.

```shell-session
$ kubectl patch crd workspaces.app.terraform.io --patch-file https://raw.githubusercontent.com/hashicorp/terraform-cloud-operator/main/docs/migration/crds/workspaces_patch_b.yaml
```

The `v2` operator will fail to proceed if a custom resource has the `v1` finalizer `finalizer.workspace.app.terraform.io`. If you encounter an error, check the logs for more information.

```shell-session
$ kubectl logs -f <POD_NAME>
```

Specifically, look for an error message such as the following.

```
ERROR	Migration	{"workspace": "default/<WORKSPACE_NAME>", "msg": "spec contains old finalizer finalizer.workspace.app.terraform.io"}
```
The `finalizer` exists to provide greater control over the migration process. Verify the custom resource, and when youâ€™re ready to migrate it, use the `kubectl patch` command to update the `finalizer` value.

```shell-session
$ kubectl patch workspace migration --type=merge --patch '{"metadata": {"finalizers": ["workspace.app.terraform.io/finalizer"]}}'
```
